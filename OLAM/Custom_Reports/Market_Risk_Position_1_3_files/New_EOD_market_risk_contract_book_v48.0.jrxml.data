<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="market_risk_EOD_contract_book" pageWidth="1684" pageHeight="1190" orientation="Landscape" columnWidth="1190" leftMargin="0" rightMargin="0" topMargin="20" bottomMargin="20" uuid="5d761ab3-f8bb-464d-9219-ad268ae39df0">
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="Local Func BI"/>
	<property name="net.sf.jasperreports.export.xls.fit.width" value="1"/>
	<property name="net.sf.jasperreports.export.pdf.size.page.to.content" value="true"/>
	<property name="com.jaspersoft.studio.unit.pageHeight" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.topMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.bottomMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.leftMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.rightMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnSpacing" value="pixel"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<property name="net.sf.jasperreports.export.xls.font.size.fix.enabled" value="false"/>
	<property name="net.sf.jasperreports.export.xls.ignore.graphics" value="false"/>
	<property name="net.sf.jasperreports.export.xls.ignore.cell.border" value="false"/>
	<property name="ireport.jasperserver.reportUnit" value="/1_ReportJan18/Market_Risk_Position_1_3"/>
	<property name="ireport.jasperserver.url" value="http://localhost:8080/jasperserver/services/repository"/>
	<style name="Crosstab_CH" mode="Opaque" backcolor="#FFCC00">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab_CG" mode="Opaque" backcolor="#FFFFFF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab_CT" mode="Opaque" backcolor="#005FB3">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab_CD" mode="Opaque" backcolor="#FFFFFF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 1_CH" mode="Opaque" backcolor="#F0F8FF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 1_CG" mode="Opaque" backcolor="#BFE1FF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 1_CT" mode="Opaque" backcolor="#005FB3">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 1_CD" mode="Opaque" backcolor="#FFFFFF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 2_CH" mode="Opaque" backcolor="#FFCC00">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 2_CG" mode="Opaque" backcolor="#BFE1FF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 2_CT" mode="Opaque" backcolor="#FFFFFF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<style name="Crosstab 2_CD" mode="Opaque" backcolor="#FFFFFF">
		<box>
			<pen lineWidth="0.5" lineColor="#000000"/>
			<topPen lineWidth="0.5" lineColor="#000000"/>
			<leftPen lineWidth="0.5" lineColor="#000000"/>
			<bottomPen lineWidth="0.5" lineColor="#000000"/>
			<rightPen lineWidth="0.5" lineColor="#000000"/>
		</box>
	</style>
	<subDataset name="ctrbook" uuid="ccf7dee5-9111-4f3c-84e2-2a0859bfe0fd">
		<property name="com.jaspersoft.studio.data.defaultdataadapter" value="Local Func BI"/>
		<parameter name="cbk" class="java.lang.String"/>
		<parameter name="pc" class="java.lang.String"/>
		<parameter name="cmd" class="java.lang.String"/>
		<parameter name="shipmonth" class="java.lang.String"/>
		<parameter name="futterm" class="java.lang.String"/>
		<parameter name="LE_Filter" class="java.lang.String">
			<parameterDescription><![CDATA[]]></parameterDescription>
			<defaultValueExpression><![CDATA[' ']]></defaultValueExpression>
		</parameter>
		<parameter name="QSTR_Filter" class="java.lang.String" isForPrompting="false">
			<defaultValueExpression><![CDATA[" AND CONTRACT_BOOK IN ('" + $P{LE_Filter} + "')"]]></defaultValueExpression>
		</parameter>
		<parameter name="asofdate" class="java.util.Date"/>
		<parameter name="col_group" class="java.lang.String"/>
		<parameter name="origindate" class="java.util.Date" isForPrompting="false">
			<defaultValueExpression><![CDATA[]]></defaultValueExpression>
		</parameter>
		<parameter name="instrument_type" class="java.lang.String"/>
		<parameter name="QSTR_Filter_1" class="java.lang.String" isForPrompting="false">
			<parameterDescription><![CDATA[]]></parameterDescription>
			<defaultValueExpression><![CDATA[" AND w.CONTRACT_BOOK IN ('" + $P{LE_Filter} + "')"]]></defaultValueExpression>
		</parameter>
		<queryString>
			<![CDATA[SELECT	QTY
		,CONTRACT_BOOK
		,COMMODITY
		,POSITION_TYPE
		,FLAG
		,ORDERBY
		,POSITION
		,SHIP_MONTH
		,MONTHNUMBER
		,INS_TYPE
FROM
(
SELECT SUM(QTY) QTY
             ,CONTRACT_BOOK
             ,COMMODITY
             ,POSITION_TYPE
             ,FLAG
             ,ORDERBY
             ,POSITION
             ,CASE WHEN $P{col_group} = 'sm' THEN SHIP_MONTH
                      WHEN $P{col_group} = 'tm' THEN TERM_MONTH
                      WHEN $P{col_group} = 'pc' THEN PROFIT_CENTER
             END AS SHIP_MONTH
             ,CASE WHEN $P{col_group} = 'sm' THEN MONTHNUMBER
                      WHEN $P{col_group} = 'tm' THEN
			CASE WHEN TERM_MONTH = 'Expired' THEN MONTHNUMBER
			ELSE
				convert(integer,convert(varchar(6),cast('01-' + replace(TERM_MONTH,' ','-') as date),112))
			END
                      WHEN $P{col_group} = 'pc' THEN 1
             END AS MONTHNUMBER
             ,CASE WHEN POSITION_TYPE = 'Futures' THEN 'Futures'
                    WHEN POSITION_TYPE = 'Listed Options Delta' THEN 'Options'
                    ELSE 'Physical'
             END AS INS_TYPE

FROM
(
SELECT  QTY
		,CONTRACT_BOOK
		,COMMODITY
		,POSITION_TYPE
		,FLAG
		,ORDERBY
		,POSITION
		,SHIP_MONTH
		,SHIP_MONTH AS TERM_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
FROM
(
SELECT Sum(QUANTITY)                        AS QTY,
       w.CONTRACT_BOOK as CONTRACT_BOOK,
       w.CONTRACT_BOOK + ' ' + A.MATERIAL_GROUP COLLATE DATABASE_DEFAULT AS COMMODITY,
       'Stock - Fixed Price'                AS POSITION_TYPE,
       0                                    AS FLAG,
       11                                   AS ORDERBY,
       'Origin Position'                    AS POSITION,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                        + '-'
                                                                                                                                        + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
       END                                  AS SHIP_MONTH,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
       END                                  AS MONTHNUMBER,
	   A.PROFIT_CENTER as PROFIT_CENTER
FROM   DM_POSITION_DATA A
JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT 
WHERE  A.ORIGIN_DATA_TYPE = 'IV'
AND REPORT_DATE = $P{origindate}

AND MATERIAL_GROUP like $P{cmd}
AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
AND A.PROFIT_CENTER like $P{pc}
$P!{QSTR_Filter_1}
GROUP  BY CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                           + '-'
                                                                                                                                           + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
          END,
          CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
          END,
          MATERIAL_GROUP,
          w.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  DELIVERY_MONTH_AND_YEAR
UNION ALL
SELECT 0                                        AS QTY,
       w.CONTRACT_BOOK  as CONTRACT_BOOK,
       w.CONTRACT_BOOK + ' ' + A.MATERIAL_GROUP COLLATE DATABASE_DEFAULT     AS COMMODITY,
       'Stock - Differential Price' AS POSITION_TYPE,
       0                                        AS FLAG,
       12                                       AS ORDERBY,
       'Origin Position'                        AS POSITION,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                        + '-'
                                                                                                                                        + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
       END                                      AS SHIP_MONTH,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
       END                                      AS MONTHNUMBER,
	   A.PROFIT_CENTER as PROFIT_CENTER
FROM   DM_POSITION_DATA A
JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center  COLLATE DATABASE_DEFAULT
WHERE  A.ORIGIN_DATA_TYPE = 'IV'
AND A.REPORT_DATE = $P{origindate}

AND MATERIAL_GROUP like $P{cmd}
AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
AND A.PROFIT_CENTER like $P{pc}
$P!{QSTR_Filter_1}
GROUP  BY CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                           + '-'
                                                                                                                                           + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
          END,
          CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
          END,
          MATERIAL_GROUP,
          w.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  DELIVERY_MONTH_AND_YEAR
UNION ALL
SELECT Sum(CASE
             WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN QUANTITY
             ELSE -QUANTITY
           END)                             AS QTY,
       w.CONTRACT_BOOK as CONTRACT_BOOK,
       w.CONTRACT_BOOK + ' ' + A.MATERIAL_GROUP COLLATE DATABASE_DEFAULT AS COMMODITY,
       CASE
         WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN 'Purchase Contract - Fixed Price'
         ELSE 'Sales Contract - Fixed Price'
       END                                  AS POSITION_TYPE,
       0                                    AS FLAG,
       CASE
         WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN 13
         ELSE 15
       END                                  AS ORDERBY,
       'Origin Position'                    AS POSITION,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
       END                                  AS SHIP_MONTH,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
       END                                  AS MONTHNUMBER,
	   A.PROFIT_CENTER as PROFIT_CENTER
FROM   DM_POSITION_DATA A
JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center  COLLATE DATABASE_DEFAULT
WHERE  PRICED_UNPRICED = 'Priced'
AND REPORT_DATE = $P{origindate}
       AND A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )

AND MATERIAL_GROUP like $P{cmd}
AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
AND A.PROFIT_CENTER like $P{pc}
$P!{QSTR_Filter_1}
GROUP  BY CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
          END,
          CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
          END,
          MATERIAL_GROUP,
          A.ORIGIN_DATA_TYPE,
          w.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  DELIVERY_MONTH_AND_YEAR
UNION ALL
SELECT Sum(CASE
             WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN QUANTITY
             ELSE -QUANTITY
           END)                             AS QTY,
       w.CONTRACT_BOOK as CONTRACT_BOOK,
       w.CONTRACT_BOOK + ' ' + A.MATERIAL_GROUP COLLATE DATABASE_DEFAULT AS COMMODITY,
       CASE
         WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN 'Purchase Contract - Differential Price'
         ELSE 'Sales Contract - Differential Price'
       END                                  AS POSITION_TYPE,
       0                                    AS FLAG,
       CASE
         WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN 14
         ELSE 16
       END                                  AS ORDERBY,
       'Origin Position'                    AS POSITION,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
       END                                  AS SHIP_MONTH,
       CASE
         WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
       END                                  AS MONTHNUMBER,
	   A.PROFIT_CENTER as PROFIT_CENTER
FROM   DM_POSITION_DATA A
JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center  COLLATE DATABASE_DEFAULT
WHERE  PRICED_UNPRICED = 'Unpriced'
AND REPORT_DATE = $P{origindate}
       AND A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )

AND MATERIAL_GROUP like $P{cmd}
AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
AND A.PROFIT_CENTER like $P{pc}
$P!{QSTR_Filter_1}
GROUP  BY CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
          END,
          CASE
            WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
          END,
          MATERIAL_GROUP,
          A.ORIGIN_DATA_TYPE,
          w.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  DELIVERY_MONTH_AND_YEAR
UNION ALL
SELECT Sum(QTY)                        AS QTY,
       CONTRACT_BOOK,
       CONTRACT_BOOK + ' ' + COMMODITY AS COMMODITY,
       NULL                            AS POSITION_TYPE,
       1                               AS FLAG,
       17                              AS ORDERBY,
       'Origin Position'               AS POSITION,
       SHIP_MONTH,
       MONTHNUMBER,
	   PROFIT_CENTER
FROM   (SELECT Sum(QUANTITY)  AS QTY,
               w.CONTRACT_BOOK as CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER as PROFIT_CENTER
        FROM   DM_POSITION_DATA A
	JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center  COLLATE DATABASE_DEFAULT
        WHERE  A.ORIGIN_DATA_TYPE = 'IV'
		AND REPORT_DATE = $P{origindate}

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
        SELECT Sum(CASE
                     WHEN A.ORIGIN_DATA_TYPE = 'PO' THEN QUANTITY
                     WHEN A.ORIGIN_DATA_TYPE = 'SO' THEN -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK as CONTRACT_BOOK ,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER as PROFIT_CENTER
        FROM   DM_POSITION_DATA A
	JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center  COLLATE DATABASE_DEFAULT
        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
       $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR)CTR
GROUP  BY SHIP_MONTH,
          MONTHNUMBER,
          COMMODITY,
          CONTRACT_BOOK,
		  PROFIT_CENTER
) T1
UNION ALL
SELECT DISTINCT 0                                    AS QTY,
                CONTRACT_BOOK   COLLATE DATABASE_DEFAULT                     AS CONTRACT_BOOK,
                CONTRACT_BOOK + ' ' + MATERIAL_GROUP COLLATE DATABASE_DEFAULT AS COMMODITY,
                D.POSITION_TYPE,
                CASE
					WHEN D.POSITION_TYPE IS NULL THEN 1
					ELSE 0
				END                                  AS FLAG,
                D.ORDERBY,
                D.POSITION,
                CASE
                  WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                  ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                       + '-'
                       + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                END                                  AS SHIP_MONTH,
				CASE
                  WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                  ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                       + '-'
                       + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                END                                  AS TERM_MONTH,
                CASE
                  WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                  ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                END                                  AS MONTHNUMBER,
				PROFIT_CENTER
FROM   DM_POSITION_DATA A
       FULL JOIN (SELECT 'Origin Position'                 AS POSITION,
                         'Stock - Fixed Price'			   AS POSITION_TYPE,
                         11                                AS ORDERBY
                  UNION ALL
				  SELECT 'Origin Position'                 AS POSITION,
                         'Stock - Differential Price' AS POSITION_TYPE,
                         12                                AS ORDERBY
                  UNION ALL
				  SELECT 'Origin Position'                 AS POSITION,
                         'Purchase Contract - Fixed Price' AS POSITION_TYPE,
                         13                                AS ORDERBY
                  UNION ALL
                  SELECT 'Origin Position'              AS POSITION,
                         'Sales Contract - Fixed Price' AS POSITION_TYPE,
                         15                             AS ORDERBY
                  UNION ALL
                  SELECT 'Origin Position'                                    AS POSITION,
                         'Purchase Contract - Differential Price' AS POSITION_TYPE,
                         14                                                   AS ORDERBY
                  UNION ALL
                  SELECT 'Origin Position'                                 AS POSITION,
                         'Sales Contract - Differential Price' AS POSITION_TYPE,
                         16                                                AS ORDERBY
				  UNION ALL
				  SELECT 'Origin Position'       AS POSITION,
                         NULL					 AS POSITION_TYPE,
                         17                      AS ORDERBY) D
              ON 1 = 1
WHERE  DELIVERY_MONTH_AND_YEAR IS NOT NULL
AND CONTRACT_BOOK like $P{cbk}
AND MATERIAL_GROUP like $P{cmd}
AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
$P!{QSTR_Filter}
--OIL Data
UNION ALL
--VISHAL for Profit Center
SELECT  SUM(QTY) QTY
		,CONTRACT_BOOK
		,COMMODITY
		,POSITION_TYPE
		,FLAG
		,ORDERBY
		,POSITION
		,SHIP_MONTH
		,SHIP_MONTH AS TERM_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		FROM
		(
SELECT A.POSITION_ID,ISNULL(MAX(CASE
             WHEN ( PRICING_TYPE = 'PRICED'
                     OR ( PRICING_TYPE = 'UNPRICED'
                          AND A.ALLOCATION_ID <> PRICING_ID ) ) THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                            AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       'Stock - Fixed Price'               AS POSITION_TYPE,
       0                                   AS FLAG,
       21                                  AS ORDERBY,
       'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID

			   --360748
			   ----360215 - Start
			   LEFT JOIN (
					--SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					--FROM
					--(
				SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY,X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID--, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID --AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--INVPOST AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_FIXED_PRICE_QTY > 0 )
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,A.POSITION_ID
  ) T
		  GROUP BY CONTRACT_BOOK
		,COMMODITY
		,POSITION_TYPE
		,FLAG
		,ORDERBY
		,POSITION
		,SHIP_MONTH
		,SHIP_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
UNION ALL
SELECT ISNULL(SUM(CASE
             WHEN PRICING_TYPE = 'UNPRICED'
                  AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
                  AND BASIS_MARKET_PRICE_INDEX <> 'NA'
                  AND A.ALLOCATION_ID = A.PRICING_ID THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                                 AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY      AS COMMODITY,
       'Stock - Differential Price' AS POSITION_TYPE,
       0                                        AS FLAG,
       22                                       AS ORDERBY,
       'OIL Position'                           AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					FROM
					(
				--SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
				--	FROM
				--	(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_PROV_PRICE_QTY
							  X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_PROV_PRICE_QTY > 0 )
--AND NOT EXISTS (SELECT POSITION_ID FROM DAILY_PNL_REALIZATION B WHERE A.POSITION_ID = B.POSITION_ID)
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH
UNION ALL
SELECT
--SELECT Sum(CASE
--             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--           END)                            AS QTY,
			CASE WHEN B.TOTAL_FIXED_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN

				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY
					 ELSE -B.TOTAL_FIXED_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       CASE
         WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Fixed Price'
         ELSE 'Sales Contract - Fixed Price'
       END                                 AS POSITION_TYPE,
       0                                   AS FLAG,
       CASE
         WHEN A.LONG_SHORT = 'LONG' THEN 23
         ELSE 25
       END                                 AS ORDERBY,
       'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND ( PRICING_TYPE = 'PRICED'
              OR ( PRICING_TYPE = 'UNPRICED'
                   AND A.ALLOCATION_ID <> PRICING_ID ) )
				   AND CTR_TYPE <> 'PAPER'	-- by Vishal
				   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,A.POSITION_ID,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_FIXED_PRICE_QTY,A.ALLOCATION_TYPE
UNION ALL
SELECT
			CASE WHEN B.TOTAL_PROV_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN
					Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
				   -
				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY
					 ELSE -B.TOTAL_PROV_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       CASE
         WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Differential Price'
         ELSE 'Sales Contract - Differential Price'
       END                                 AS POSITION_TYPE,
       0                                   AS FLAG,
       CASE
         WHEN A.LONG_SHORT = 'LONG' THEN 24
         ELSE 26
       END                                 AS ORDERBY,
       'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY
							  --X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND PRICING_TYPE = 'UNPRICED'
       AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
       AND BASIS_MARKET_PRICE_INDEX <> 'NA'
       AND A.ALLOCATION_ID = A.PRICING_ID
	   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_PROV_PRICE_QTY,A.ALLOCATION_TYPE
UNION ALL
SELECT Sum(QTY)                        AS QTY,
       CONTRACT_BOOK,
       CONTRACT_BOOK + ' ' + COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       NULL                            AS POSITION_TYPE,
       1                               AS FLAG,
       27                              AS ORDERBY,
       'OIL Position'                  AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (
			SELECT  SUM(QTY) QTY
		,CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH AS TERM_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		FROM
		(
SELECT A.POSITION_ID,ISNULL(MAX(CASE
             WHEN ( PRICING_TYPE = 'PRICED'
                     OR ( PRICING_TYPE = 'UNPRICED'
                          AND A.ALLOCATION_ID <> PRICING_ID ) ) THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                            AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --'Stock - Fixed Price'               AS POSITION_TYPE,
       --0                                   AS FLAG,
       --21                                  AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
			   --360748
			   ----360215 - Start
			   LEFT JOIN (
					--SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					--FROM
					--(
				SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY,X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID--, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID --AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--INVPOST AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_FIXED_PRICE_QTY > 0 )
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,A.POSITION_ID
  ) T
		  GROUP BY CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
UNION ALL
SELECT ISNULL(SUM(CASE
             WHEN PRICING_TYPE = 'UNPRICED'
                  AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
                  AND BASIS_MARKET_PRICE_INDEX <> 'NA'
                  AND A.ALLOCATION_ID = A.PRICING_ID THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                                 AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY      AS COMMODITY,
       --'Stock - Differential Price' AS POSITION_TYPE,
       --0                                        AS FLAG,
       --22                                       AS ORDERBY,
       --'OIL Position'                           AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					FROM
					(
				--SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
				--	FROM
				--	(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_PROV_PRICE_QTY
							  X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_PROV_PRICE_QTY > 0 )
--AND NOT EXISTS (SELECT POSITION_ID FROM DAILY_PNL_REALIZATION B WHERE A.POSITION_ID = B.POSITION_ID)
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH
UNION ALL
SELECT
--SELECT Sum(CASE
--             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--           END)                            AS QTY,
			CASE WHEN B.TOTAL_FIXED_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN

				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY
					 ELSE -B.TOTAL_FIXED_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Fixed Price'
       --  ELSE 'Sales Contract - Fixed Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 23
       --  ELSE 25
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND ( PRICING_TYPE = 'PRICED'
              OR ( PRICING_TYPE = 'UNPRICED'
                   AND A.ALLOCATION_ID <> PRICING_ID ) )
				   AND CTR_TYPE <> 'PAPER'	-- by Vishal
				   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,A.POSITION_ID,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_FIXED_PRICE_QTY,A.ALLOCATION_TYPE
UNION ALL
SELECT
			CASE WHEN B.TOTAL_PROV_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN
					Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
				   -
				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY
					 ELSE -B.TOTAL_PROV_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
	   A.COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Differential Price'
       --  ELSE 'Sales Contract - Differential Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 24
       --  ELSE 26
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY
							  --X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND PRICING_TYPE = 'UNPRICED'
       AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
       AND BASIS_MARKET_PRICE_INDEX <> 'NA'
       AND A.ALLOCATION_ID = PRICING_ID
	   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_PROV_PRICE_QTY,A.ALLOCATION_TYPE
				  ) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT DISTINCT 0                               AS QTY,
                CONTRACT_BOOK                   AS CONTRACT_BOOK,
                CONTRACT_BOOK + ' ' + COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
                D.POSITION_TYPE,
                CASE
				   WHEN D.POSITION_TYPE IS NULL THEN 1
				   ELSE 0
			    END     AS FLAG,
                D.ORDERBY,
                D.POSITION,
                CASE
                  WHEN COALESCE(PHYSICAL_DELIVERY_MONTHNUMBER, FUTURE_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                                   + '-'
                                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                  ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), COALESCE(PHYSICAL_DELIVERY_MONTH, FUTURE_DELIVERY_MONTH), 113), 8), 1)
                       + Lower(RIGHT(CONVERT(VARCHAR(3), COALESCE(PHYSICAL_DELIVERY_MONTH, FUTURE_DELIVERY_MONTH), 113), 2))
                       + '-'
                       + RIGHT(RIGHT(CONVERT(VARCHAR(11), COALESCE(PHYSICAL_DELIVERY_MONTH, FUTURE_DELIVERY_MONTH), 113), 8), 2)
                END                             AS SHIP_MONTH,
				CASE
				 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																														   + '-'
																														   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
				 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
					  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
					  + '-'
					  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
			   END                                      AS TERM_MONTH,
                CASE
                  WHEN COALESCE(PHYSICAL_DELIVERY_MONTHNUMBER, FUTURE_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                  ELSE COALESCE(PHYSICAL_DELIVERY_MONTHNUMBER, FUTURE_DELIVERY_MONTHNUMBER)
                END                             AS MONTHNUMBER,
				PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       FULL JOIN (SELECT 'OIL Position'        AS POSITION,
                              'Stock - Fixed Price' AS POSITION_TYPE,
                              21                    AS ORDERBY
                       UNION ALL
                       SELECT 'OIL Position'                           AS POSITION,
                              'Stock - Differential Price' AS POSITION_TYPE,
                              22                                       AS ORDERBY
                       UNION ALL
                       SELECT 'OIL Position'                    AS POSITION,
                              'Purchase Contract - Fixed Price' AS POSITION_TYPE,
                              23                                AS ORDERBY
                       UNION ALL
                       SELECT 'OIL Position'                 AS POSITION,
                              'Sales Contract - Fixed Price' AS POSITION_TYPE,
                              25                             AS ORDERBY
                       UNION ALL
                       SELECT 'OIL Position'                                       AS POSITION,
                              'Purchase Contract - Differential Price' AS POSITION_TYPE,
                              24                                                   AS ORDERBY
                       UNION ALL
                       SELECT 'OIL Position'                                    AS POSITION,
                              'Sales Contract - Differential Price' AS POSITION_TYPE,
                              26                                                AS ORDERBY
                       UNION ALL
                       SELECT 'OIL Position' AS POSITION,
                              NULL           AS POSITION_TYPE,
                              27             AS ORDERBY
                       UNION ALL
                       SELECT 'Net Fixed Price Position' AS POSITION,
                              NULL                       AS POSITION_TYPE,
                              31                         AS ORDERBY
                       UNION ALL
                       SELECT 'Net Differential Price Position' AS POSITION,
                              NULL                              AS POSITION_TYPE,
                              32                                AS ORDERBY
                       UNION ALL
                       SELECT 'Net Derivatives Position' AS POSITION,
                              'Futures'                  AS POSITION_TYPE,
                              41                         AS ORDERBY
                       UNION ALL
                       SELECT 'Net Derivatives Position' AS POSITION,
                              'Listed Options Delta'     AS POSITION_TYPE,
                              42                         AS ORDERBY
                       UNION ALL
                       SELECT 'Net Derivatives Position' AS POSITION,
                              'Paper Trades'             AS POSITION_TYPE,
                              43                         AS ORDERBY
                       UNION ALL
                       SELECT 'Net Derivatives Position' AS POSITION,
                              NULL                       AS POSITION_TYPE,
                              44                         AS ORDERBY
                       UNION ALL
                       SELECT 'Outright Position' AS POSITION,
                              NULL                AS POSITION_TYPE,
                              51                  AS ORDERBY
                       UNION ALL
                       SELECT 'Basis Position (Balance to Buy/Sell)' AS POSITION,
                              NULL                                   AS POSITION_TYPE,
                              52                                     AS ORDERBY
                       UNION ALL
                       SELECT 'Structure Position' AS POSITION,
                              NULL                 AS POSITION_TYPE,
                              54                   AS ORDERBY
                       UNION ALL
                       SELECT 'Unpriced Position' AS POSITION,
                              NULL                AS POSITION_TYPE,
                              53                  AS ORDERBY) D
              ON 1 = 1
WHERE  COALESCE(PHYSICAL_DELIVERY_MONTHNUMBER, FUTURE_DELIVERY_MONTHNUMBER) IS NOT NULL
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND EOD_DATE=$P{asofdate}
$P!{QSTR_Filter}
UNION ALL
SELECT Sum(QTY)                                AS QTY,
       CTR.CONTRACT_BOOK,
       CTR.CONTRACT_BOOK + ' ' + CTR.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       NULL                                    AS POSITION_TYPE,
       1                                       AS FLAG,
       31                                      AS ORDERBY,
       'Net Fixed Price Position'              AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (SELECT Sum(QUANTITY)  AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END           AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
					JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like '%')w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT

        WHERE  A.ORIGIN_DATA_TYPE = 'IV'
		AND REPORT_DATE = $P{origindate}

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR

        UNION ALL
        SELECT Sum(CASE
                     WHEN LONG_SHORT = 'Long' THEN QUANTITY
                     ELSE -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
		JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT 

        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Priced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
        SELECT
--SELECT Sum(CASE
--             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--           END)                            AS QTY,
			CASE WHEN B.TOTAL_FIXED_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN

				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY
					 ELSE -B.TOTAL_FIXED_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT AS CONTRACT_BOOK ,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Fixed Price'
       --  ELSE 'Sales Contract - Fixed Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 23
       --  ELSE 25
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND ( PRICING_TYPE = 'PRICED'
              OR ( PRICING_TYPE = 'UNPRICED'
                   AND A.ALLOCATION_ID <> PRICING_ID ) )
				   AND CTR_TYPE <> 'PAPER'	-- by Vishal
				   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,A.POSITION_ID,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_FIXED_PRICE_QTY,A.ALLOCATION_TYPE
				  --360215-start
				  UNION ALL
				  SELECT  SUM(QTY) QTY
		,CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH AS TERM_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		FROM
		(
SELECT A.POSITION_ID,ISNULL(MAX(CASE
             WHEN ( PRICING_TYPE = 'PRICED'
                     OR ( PRICING_TYPE = 'UNPRICED'
                          AND A.ALLOCATION_ID <> PRICING_ID ) ) THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                            AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --'Stock - Fixed Price'               AS POSITION_TYPE,
       --0                                   AS FLAG,
       --21                                  AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					--SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					--FROM
					--(
				SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY,X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID--, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID --AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--INVPOST AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_FIXED_PRICE_QTY > 0 )
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,A.POSITION_ID
  ) T
		  GROUP BY CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER

				  --360215-end

				  ) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT Sum(QTY)                                AS QTY,
       CTR.CONTRACT_BOOK,
       CTR.CONTRACT_BOOK + ' ' + CTR.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       NULL                                    AS POSITION_TYPE,
       1                                       AS FLAG,
       32                                      AS ORDERBY,
       'Net Differential Price Position'       AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (SELECT Sum(CASE
                     WHEN LONG_SHORT = 'Long' THEN QUANTITY
                     ELSE -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
					JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like '%')w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT

        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Unpriced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
			--360215 Start
			SELECT ISNULL(SUM(CASE
             WHEN PRICING_TYPE = 'UNPRICED'
                  AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
                  AND BASIS_MARKET_PRICE_INDEX <> 'NA'
                  AND A.ALLOCATION_ID = A.PRICING_ID THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                                 AS QTY,
       A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT AS CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY      AS COMMODITY,
       --'Stock - Differential Price' AS POSITION_TYPE,
       --0                                        AS FLAG,
       --22                                       AS ORDERBY,
       --'OIL Position'                           AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					FROM
					(
				--SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
				--	FROM
				--	(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_PROV_PRICE_QTY
							  X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_PROV_PRICE_QTY > 0 )
--AND NOT EXISTS (SELECT POSITION_ID FROM DAILY_PNL_REALIZATION B WHERE A.POSITION_ID = B.POSITION_ID)
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH
UNION ALL
SELECT
			CASE WHEN B.TOTAL_PROV_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN
					Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
				   -
				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY
					 ELSE -B.TOTAL_PROV_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Differential Price'
       --  ELSE 'Sales Contract - Differential Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 24
       --  ELSE 26
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY
							  --X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND PRICING_TYPE = 'UNPRICED'
       AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
       AND BASIS_MARKET_PRICE_INDEX <> 'NA'
       AND A.ALLOCATION_ID = PRICING_ID
	   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_PROV_PRICE_QTY,A.ALLOCATION_TYPE
			--360215 End
				  ) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT Sum(CASE
             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
           END)                            AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       'Futures'                           AS POSITION_TYPE,
       0                                   AS FLAG,
       41                                  AS ORDERBY,
       'Net Derivatives Position'          AS POSITION,
       CASE
         WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE FUTURE_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
WHERE  A.INSTRUMENT_TYPE = 'FUTURES'
AND EOD_DATE  = $P{asofdate}
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND FUTURE_DELIVERY_MONTH LIKE $P{shipmonth}
AND CTR.CONTRACT_TERM LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
            WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
          END,
          CASE
            WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE FUTURE_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  				 --
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
UNION ALL
SELECT Sum(CASE
             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
             ELSE -( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
           END)                            AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       'Listed Options Delta'              AS POSITION_TYPE,
       0                                   AS FLAG,
       42                                  AS ORDERBY,
       'Net Derivatives Position'          AS POSITION,
       CASE
         WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE OPTION_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	  A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
WHERE  A.INSTRUMENT_TYPE = 'OPTIONS'
AND EOD_DATE  = $P{asofdate}
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND OPTION_DELIVERY_MONTH LIKE $P{shipmonth}
AND CTR.CONTRACT_TERM LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
            WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
          END,
          CASE
            WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE OPTION_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  OPTION_DELIVERY_MONTHNUMBER,
		  OPTION_DELIVERY_MONTH
UNION ALL
SELECT Sum(CASE
             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
           END)                            AS QTY,
       A.CONTRACT_BOOK,
       A.CONTRACT_BOOK + ' ' + A.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       'Paper Trades'                      AS POSITION_TYPE,
       0                                   AS FLAG,
       43                                  AS ORDERBY,
       'Net Derivatives Position'          AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND LONG_SHORT = 'LONG'
       AND A.ALLOCATION_TYPE <> 'STOCK'
       AND CTR_TYPE = 'PAPER'
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  A.PROFIT_CENTER,
		  			--
			PHYSICAL_DELIVERY_MONTHNUMBER,
			PHYSICAL_DELIVERY_MONTH,
			FUTURE_DELIVERY_MONTHNUMBER,
			FUTURE_DELIVERY_MONTH
UNION ALL
SELECT Sum(QTY)                                AS QTY,
       CTR.CONTRACT_BOOK,
       CTR.CONTRACT_BOOK + ' ' + CTR.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       NULL                                    AS POSITION_TYPE,
       1                                       AS FLAG,
       44                                      AS ORDERBY,
       'Net Derivatives Position'              AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (SELECT Sum(CASE
                     WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               A.CONTRACT_BOOK ,
               A.COMMODITY,
               CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
               END      AS TERM_MONTH,
               CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE FUTURE_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'FUTURES'
		AND ($P{instrument_type} = 'Futures' or $P{instrument_type} = '%')
		AND EOD_DATE  = $P{asofdate}
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND FUTURE_DELIVERY_MONTH LIKE $P{shipmonth}
        AND CTR.CONTRACT_TERM LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
                  END,
                  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE FUTURE_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
        UNION ALL
        SELECT Sum(CASE
                     WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               A.CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
               END      AS TERM_MONTH,
               CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE OPTION_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'OPTIONS'
		AND ($P{instrument_type} = 'Options' or $P{instrument_type} = '%')
		AND EOD_DATE  = $P{asofdate}
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND OPTION_DELIVERY_MONTH LIKE $P{shipmonth}
        AND CTR.CONTRACT_TERM LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
                  END,
                  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE OPTION_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  OPTION_DELIVERY_MONTHNUMBER,
				  OPTION_DELIVERY_MONTH
        UNION ALL
        SELECT --Sum(( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )) AS QTY,
				Sum(CASE
						WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
						ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					END)                            AS QTY,
               A.CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
               END                                                         AS SHIP_MONTH,
			   CASE
				 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
				 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
					  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
					  + '-'
					  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
			   END                                 AS TERM_MONTH,
               CASE
                 WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE PHYSICAL_DELIVERY_MONTHNUMBER
               END                                                         AS MONTHNUMBER,
			   PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
		AND EOD_DATE  = $P{asofdate}
               --AND LONG_SHORT = 'LONG'
               AND A.ALLOCATION_TYPE <> 'STOCK'
               AND CTR_TYPE = 'PAPER'
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
        AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
					 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
					 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
						  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
						  + '-'
						  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
				   END,
                  CASE
                    WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE PHYSICAL_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  				 --
				  PHYSICAL_DELIVERY_MONTHNUMBER,
				  PHYSICAL_DELIVERY_MONTH,
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT Sum(QTY)                                AS QTY,
       CTR.CONTRACT_BOOK,
       CTR.CONTRACT_BOOK + ' ' + CTR.COMMODITY COLLATE DATABASE_DEFAULT  AS COMMODITY,
       NULL                                    AS POSITION_TYPE,
       1                                       AS FLAG,
       51                                      AS ORDERBY,
       'Outright Position'                     AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (SELECT Sum(CASE
                     WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               A.CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
               END      AS TERM_MONTH,
               CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE FUTURE_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'FUTURES'
		AND ($P{instrument_type} = 'Futures' OR $P{instrument_type} = '%')
		AND EOD_DATE  = $P{asofdate}
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND FUTURE_DELIVERY_MONTH LIKE $P{shipmonth}
        AND CTR.CONTRACT_TERM LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
                  END,
                  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE FUTURE_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  				 --
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
        UNION ALL
        SELECT Sum(CASE
                     WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               A.CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
               END      AS TERM_MONTH,
               CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE OPTION_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'OPTIONS'
			AND ($P{instrument_type} = 'Options' OR $P{instrument_type} = '%')
		AND EOD_DATE  = $P{asofdate}
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND OPTION_DELIVERY_MONTH LIKE $P{shipmonth}
        AND CTR.CONTRACT_TERM LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
                  END,
                  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE OPTION_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  				 --
				  OPTION_DELIVERY_MONTHNUMBER,
				  OPTION_DELIVERY_MONTH
        UNION ALL
        SELECT --Sum(( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )) AS QTY,
				Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)                            AS QTY,
               A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT AS CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
               END                                                         AS SHIP_MONTH,
			   CASE
				 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
				 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
					  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
					  + '-'
					  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
			   END                                 AS TERM_MONTH,
               CASE
                 WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE PHYSICAL_DELIVERY_MONTHNUMBER
               END                                                         AS MONTHNUMBER,
			   PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
		AND EOD_DATE  = $P{asofdate}
               --AND LONG_SHORT = 'LONG'
               --AND A.ALLOCATION_TYPE <> 'STOCK'
               AND CTR_TYPE = 'PAPER'
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
        AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
					 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
					 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
						  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
						  + '-'
						  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
				   END ,
                  CASE
                    WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE PHYSICAL_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  				 --
				  PHYSICAL_DELIVERY_MONTHNUMBER,
				  PHYSICAL_DELIVERY_MONTH,
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
        UNION ALL
		--Net Fixed Price 360215 - Start
		SELECT Sum(QUANTITY)  AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END           AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
		JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like '%')w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT


        WHERE  A.ORIGIN_DATA_TYPE = 'IV'
		AND REPORT_DATE = $P{origindate}

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR

        UNION ALL
        SELECT Sum(CASE
                     WHEN LONG_SHORT = 'Long' THEN QUANTITY
                     ELSE -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
		JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like '%')w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT

        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Priced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
        SELECT
--SELECT Sum(CASE
--             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--           END)                            AS QTY,
			CASE WHEN B.TOTAL_FIXED_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN

				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY
					 ELSE -B.TOTAL_FIXED_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Fixed Price'
       --  ELSE 'Sales Contract - Fixed Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 23
       --  ELSE 25
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND ( PRICING_TYPE = 'PRICED'
              OR ( PRICING_TYPE = 'UNPRICED'
                   AND A.ALLOCATION_ID <> PRICING_ID ) )
				   AND CTR_TYPE <> 'PAPER'	-- by Vishal
				   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,A.POSITION_ID,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_FIXED_PRICE_QTY,A.ALLOCATION_TYPE
				  --360215-start
				  UNION ALL
				  SELECT  SUM(QTY) QTY
		,CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH AS TERM_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		FROM
		(
SELECT A.POSITION_ID,ISNULL(MAX(CASE
             WHEN ( PRICING_TYPE = 'PRICED'
                     OR ( PRICING_TYPE = 'UNPRICED'
                          AND A.ALLOCATION_ID <> PRICING_ID ) ) THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                            AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --'Stock - Fixed Price'               AS POSITION_TYPE,
       --0                                   AS FLAG,
       --21                                  AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					--SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					--FROM
					--(
				SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY,X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID--, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID --AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--INVPOST AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_FIXED_PRICE_QTY > 0 )
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,A.POSITION_ID
  ) T
		  GROUP BY CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		--Net Fixed Price 360215 - End

  --Removed Unpriced Section
				  ) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT Sum(QTY)                                AS QTY,
       CTR.CONTRACT_BOOK,
       CTR.CONTRACT_BOOK + ' ' + CTR.COMMODITY COLLATE DATABASE_DEFAULT AS COMMODITY,
       NULL                                    AS POSITION_TYPE,
       1                                       AS FLAG,
       52                                      AS ORDERBY,
       'Basis Position (Balance to Buy/Sell)'  AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (

		--Net Fixed Price 360215 - Start
		SELECT Sum(QUANTITY)  AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                + '-'
                                                                                                                                                + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END           AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
		JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT 


        WHERE  A.ORIGIN_DATA_TYPE = 'IV'
		AND REPORT_DATE = $P{origindate}

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                                                   + '-'
                                                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR

        UNION ALL
        SELECT Sum(CASE
                     WHEN LONG_SHORT = 'Long' THEN QUANTITY
                     ELSE -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
		JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT 


        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Priced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
        SELECT
--SELECT Sum(CASE
--             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
--           END)                            AS QTY,
			CASE WHEN B.TOTAL_FIXED_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN

				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY
					 ELSE -B.TOTAL_FIXED_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Fixed Price'
       --  ELSE 'Sales Contract - Fixed Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 23
       --  ELSE 25
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End


WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND ( PRICING_TYPE = 'PRICED'
              OR ( PRICING_TYPE = 'UNPRICED'
                   AND A.ALLOCATION_ID <> PRICING_ID ) )
				   AND CTR_TYPE <> 'PAPER'	-- by Vishal
				   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,A.POSITION_ID,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_FIXED_PRICE_QTY,A.ALLOCATION_TYPE
				  --360215-start
				  UNION ALL
				  SELECT  SUM(QTY) QTY
		,CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH AS TERM_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		FROM
		(
SELECT A.POSITION_ID,ISNULL(MAX(CASE
             WHEN ( PRICING_TYPE = 'PRICED'
                     OR ( PRICING_TYPE = 'UNPRICED'
                          AND A.ALLOCATION_ID <> PRICING_ID ) ) THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_FIXED_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                            AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --'Stock - Fixed Price'               AS POSITION_TYPE,
       --0                                   AS FLAG,
       --21                                  AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					--SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					--FROM
					--(
				SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY,X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID--, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID --AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--INVPOST AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_FIXED_PRICE_QTY > 0 )
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,A.POSITION_ID
  ) T
		  GROUP BY CONTRACT_BOOK
		,COMMODITY
		--,POSITION_TYPE
		--,FLAG
		--,ORDERBY
		--,POSITION
		,SHIP_MONTH
		,SHIP_MONTH
		,MONTHNUMBER
		,PROFIT_CENTER
		--Net Fixed Price 360215 - End
        UNION ALL
		--Net Differentials 360215 - Start
		SELECT Sum(CASE
                     WHEN LONG_SHORT = 'Long' THEN QUANTITY
                     ELSE -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
		JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like $P{cbk})w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT 

        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Unpriced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
			--360215 Start
			SELECT ISNULL(SUM(CASE
             WHEN PRICING_TYPE = 'UNPRICED'
                  AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
                  AND BASIS_MARKET_PRICE_INDEX <> 'NA'
                  AND A.ALLOCATION_ID = A.PRICING_ID THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                                 AS QTY,
       A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY      AS COMMODITY,
       --'Stock - Differential Price' AS POSITION_TYPE,
       --0                                        AS FLAG,
       --22                                       AS ORDERBY,
       --'OIL Position'                           AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					FROM
					(
				--SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
				--	FROM
				--	(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_PROV_PRICE_QTY
							  X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_PROV_PRICE_QTY > 0 )
--AND NOT EXISTS (SELECT POSITION_ID FROM DAILY_PNL_REALIZATION B WHERE A.POSITION_ID = B.POSITION_ID)
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH
UNION ALL
SELECT
			CASE WHEN B.TOTAL_PROV_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN
					Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
				   -
				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY
					 ELSE -B.TOTAL_PROV_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Differential Price'
       --  ELSE 'Sales Contract - Differential Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 24
       --  ELSE 26
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY
							  --X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End


WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND PRICING_TYPE = 'UNPRICED'
       AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
       AND BASIS_MARKET_PRICE_INDEX <> 'NA'
       AND A.ALLOCATION_ID = PRICING_ID
	   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_PROV_PRICE_QTY,A.ALLOCATION_TYPE
		--Net Differentials 360215 - End
				  )CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT Sum(QTY)                        AS QTY,
       CONTRACT_BOOK,
       COMMODITY,
       NULL                            AS POSITION_TYPE,
       1                               AS FLAG,
       53                              AS ORDERBY,
       'Unpriced Position'             AS POSITION,
       SHIP_MONTH,
	   TERM_MONTH,
       MONTHNUMBER,
	   PROFIT_CENTER
FROM   (SELECT COMMODITY +'  '+ CONTRACT_BOOK COLLATE DATABASE_DEFAULT AS COMMODITY,
               CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
               Sum(CASE
                     WHEN LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               CASE
                 WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
				 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
				 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
					  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
					  + '-'
					  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
			   END                                 AS TERM_MONTH,
               CASE
                 WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE PHYSICAL_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  PRICING_TYPE = 'UNPRICED'
		AND EOD_DATE  = $P{asofdate}
               AND A.INSTRUMENT_TYPE = 'PHYSICAL'
               AND ( BASIS_MARKET_PRICE_INDEX IS NULL
                      OR BASIS_MARKET_PRICE_INDEX = 'NA' )
               AND ALLOCATION_ID = PRICING_ID
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
        AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
					 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
					 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
						  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
						  + '-'
						  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
				   END,
                  CASE
                    WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE PHYSICAL_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  				 --
				  PHYSICAL_DELIVERY_MONTHNUMBER,
				  PHYSICAL_DELIVERY_MONTH,
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
        UNION ALL
        SELECT MATERIAL_GROUP  +'  '+ w.CONTRACT_BOOK COLLATE DATABASE_DEFAULT AS COMMODITY,
               w.CONTRACT_BOOK,
               Sum(CASE
                     WHEN A.ORIGIN_DATA_TYPE = 'SO' THEN -QUANTITY
                     ELSE QUANTITY
                   END)       AS QTY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
					JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like '%')w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT
        WHERE  A.ORIGIN_DATA_TYPE IN ( 'IV', 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Unpriced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
UNION ALL
SELECT Sum(QTY)                                AS QTY,
       CTR.CONTRACT_BOOK,
       CTR.CONTRACT_BOOK + ' ' + CTR.COMMODITY AS COMMODITY,
       NULL                                    AS POSITION_TYPE,
       1                                       AS FLAG,
       54                                      AS ORDERBY,
       'Structure Position'                    AS POSITION,
       CTR.SHIP_MONTH,
	   CTR.TERM_MONTH,
       CTR.MONTHNUMBER,
	   CTR.PROFIT_CENTER
FROM   (SELECT Sum(CASE
                     WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT AS CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
               END      AS TERM_MONTH,
               CASE
                 WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE FUTURE_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'FUTURES'
				AND ($P{instrument_type} = 'Futures' OR $P{instrument_type} = '%')
		AND EOD_DATE  = $P{asofdate}
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND FUTURE_DELIVERY_MONTH LIKE $P{shipmonth}
        AND CTR.CONTRACT_TERM LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), FUTURE_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), FUTURE_DELIVERY_MONTH, 113), 8), 2)
                  END,
                  CASE
                    WHEN FUTURE_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE FUTURE_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
        UNION ALL
        SELECT Sum(CASE
                     WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
                     ELSE -( CURRENT_OPEN_QUANTITY * CURRENT_DELTA * UOM_FACTOR_FROM_POS_TO_RPT )
                   END) AS QTY,
               A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
               A.COMMODITY,
               CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
               END      AS SHIP_MONTH,
			   CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                      + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
               END      AS TERM_MONTH,
               CASE
                 WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE OPTION_DELIVERY_MONTHNUMBER
               END      AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DAILY_PNL_ATTRIBUTION A
               LEFT JOIN DAILY_CONTRACT_DATA CTR
                      ON A.POSITION_ID = CTR.POSITION_ID
        WHERE  A.INSTRUMENT_TYPE = 'OPTIONS'
				AND ($P{instrument_type} = 'Options' OR $P{instrument_type} = '%')
		AND EOD_DATE  = $P{asofdate}
        AND CONTRACT_BOOK like $P{cbk}
        AND COMMODITY like $P{cmd}
        AND PROFIT_CENTER like $P{pc}
        AND OPTION_DELIVERY_MONTH LIKE $P{shipmonth}
        AND CTR.CONTRACT_TERM LIKE $P{futterm}
        $P!{QSTR_Filter}
        GROUP  BY A.COMMODITY,
                  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
                  END,
				  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 1)
                         + Lower(RIGHT(CONVERT(VARCHAR(3), OPTION_DELIVERY_MONTH, 113), 2))
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), OPTION_DELIVERY_MONTH, 113), 8), 2)
                  END,
                  CASE
                    WHEN OPTION_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE OPTION_DELIVERY_MONTHNUMBER
                  END,
                  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  OPTION_DELIVERY_MONTHNUMBER,
				  OPTION_DELIVERY_MONTH
		UNION ALL
		SELECT Sum(CASE
             WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
             ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
           END)                            AS QTY,
        A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
        A.COMMODITY,
        CASE
          WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
          ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
        END                                 AS SHIP_MONTH,
		CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
        CASE
          WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
          ELSE PHYSICAL_DELIVERY_MONTHNUMBER
        END                                 AS MONTHNUMBER,
		PROFIT_CENTER
		FROM   DAILY_PNL_ATTRIBUTION A
			LEFT JOIN DAILY_CONTRACT_DATA CTR
                ON A.POSITION_ID = CTR.POSITION_ID
		WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
		AND EOD_DATE  = $P{asofdate}
			   --AND LONG_SHORT = 'LONG'
			   --360215-start
			   --AND A.ALLOCATION_TYPE <> 'STOCK'
			   --360215-End
			   AND CTR_TYPE = 'PAPER'
		AND CONTRACT_BOOK like $P{cbk}
		AND COMMODITY like $P{cmd}
		AND PROFIT_CENTER like $P{pc}
		AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
		AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
		$P!{QSTR_Filter}
		GROUP  BY A.COMMODITY,
				  CASE
					WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
					ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
						 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
						 + '-'
						 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
				  END,
				  CASE
					 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
					 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
						  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
						  + '-'
						  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
				   END,
				  CASE
					WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
					ELSE PHYSICAL_DELIVERY_MONTHNUMBER
				  END,
				  A.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  				 --
				  PHYSICAL_DELIVERY_MONTHNUMBER,
				  PHYSICAL_DELIVERY_MONTH,
				  FUTURE_DELIVERY_MONTHNUMBER,
				  FUTURE_DELIVERY_MONTH
       UNION ALL
       --Net Differentials 360215 - Start
		SELECT
		-SUM(QTY),CONTRACT_BOOK,COMMODITY,SHIP_MONTH,TERM_MONTH,MONTHNUMBER,PROFIT_CENTER
		FROM
		(
		SELECT Sum(CASE
                     WHEN LONG_SHORT = 'Long' THEN QUANTITY
                     ELSE -QUANTITY
                   END)       AS QTY,
               w.CONTRACT_BOOK,
               MATERIAL_GROUP AS COMMODITY,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS SHIP_MONTH,
			   CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                      + '-'
                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
               END            AS TERM_MONTH,
               CASE
                 WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                 ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
               END            AS MONTHNUMBER,
			   A.PROFIT_CENTER
        FROM   DM_POSITION_DATA A
					JOIN (SELECT distinct ct.CTRBOOKCODE contract_book,pc.pcname profit_center
  FROM [cxcdata_olam47].[dbo].[CTRBOOKPC] ctpc
  JOIN  [cxcdata_olam47].[dbo].[JCPROFITCENTER] pc
              ON ctpc.pcid = pc.pcid
  JOIN  [cxcdata_olam47].[dbo].[CTRBOOK] ct
              ON ctpc.ctrbookid = ct.ctrbookid
			  WHERE  CTRBOOKCODE  like '%')w
ON A.profit_center = w.profit_center COLLATE DATABASE_DEFAULT
        WHERE  A.ORIGIN_DATA_TYPE IN ( 'PO', 'SO' )
		AND REPORT_DATE = $P{origindate}
               AND PRICED_UNPRICED = 'Unpriced'

        AND MATERIAL_GROUP like $P{cmd}
        AND COALESCE(UPPER(RIGHT(CONVERT(VARCHAR(12), DELIVERY_MONTH_AND_YEAR,113),8)),'') LIKE $P{shipmonth}
        AND A.PROFIT_CENTER like $P{pc}
        $P!{QSTR_Filter_1}
        GROUP  BY CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
				  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
                    ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 3)
                         + '-'
                         + RIGHT(RIGHT(CONVERT(VARCHAR(11), DELIVERY_MONTH_AND_YEAR, 113), 8), 2)
                  END,
                  CASE
                    WHEN Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '') < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
                    ELSE Replace(LEFT(DELIVERY_MONTH_AND_YEAR, 7), '-', '')
                  END,
                  MATERIAL_GROUP,
                  w.CONTRACT_BOOK,
				  A.PROFIT_CENTER,
				  DELIVERY_MONTH_AND_YEAR
        UNION ALL
			--360215 Start
			SELECT ISNULL(SUM(CASE
             WHEN PRICING_TYPE = 'UNPRICED'
                  AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
                  AND BASIS_MARKET_PRICE_INDEX <> 'NA'
                  AND A.ALLOCATION_ID = A.PRICING_ID THEN
               CASE
                 WHEN LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY--( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
                 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
               END
           END),0)                                 AS QTY,
       A.CONTRACT_BOOK COLLATE DATABASE_DEFAULT as CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY      AS COMMODITY,
       --'Stock - Differential Price' AS POSITION_TYPE,
       --0                                        AS FLAG,
       --22                                       AS ORDERBY,
       --'OIL Position'                           AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                      AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                   + '-'
                                                                                                                   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                      AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                      AS MONTHNUMBER,
	   A.PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		--360748
			   ----360215 - Start
			   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
					FROM
					(
				--SELECT POSITION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY--,pricing_id
				--	FROM
				--	(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY,
							  --X.TOTAL_FIXED_PRICE_QTY TOTAL_FIXED_PRICE_QTY,
							  --X.TOTAL_PROV_PRICE_QTY
							  X.pricing_id
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY,pricing_id
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY,pricing_id
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID,pricing_id) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  PURCHASE_POSITION_ID POSITION_ID,
							  PURCHASE_ALLOCATION_ID ALLOCATION_ID,
							  PURCHASE_PRICING_ID PRICING_ID
							FROM REALIZATION_DETAIL DPR
							WHERE VALUATION_DATE <= $P{asofdate}
							GROUP BY PURCHASE_POSITION_ID,
									 PURCHASE_ALLOCATION_ID,
									 PURCHASE_PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID AND X.PRICING_ID = y.PRICING_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID, PRICING_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.PRICING_ID = B.PRICING_ID
		--360215 - End
WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       AND A.ALLOCATION_TYPE = 'STOCK'
--360215 - Start
AND LONG_SHORT = 'LONG'
--AND EXISTS (SELECT POSITION_ID FROM DUMP_BI_FINANCIAL_LOAD_DETAILS B WHERE A.POSITION_ID = B.POSITION_ID AND B.TOTAL_PROV_PRICE_QTY > 0 )
--AND NOT EXISTS (SELECT POSITION_ID FROM DAILY_PNL_REALIZATION B WHERE A.POSITION_ID = B.POSITION_ID)
--360215 - End
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
                                                                                                                      + '-'
                                                                                                                      + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN LEFT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 3)
																													   + '-'
																													   + RIGHT(RIGHT(CONVERT(VARCHAR(11), (CAST($P{asofdate} AS DATE)), 113), 8), 2)
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '')
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH
UNION ALL
SELECT
			CASE WHEN B.TOTAL_PROV_PRICE_QTY > 0 and A.ALLOCATION_TYPE = 'STOCK' THEN
					Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
				   -
				   ISNULL(MAX(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN B.TOTAL_PROV_PRICE_QTY
					 ELSE -B.TOTAL_PROV_PRICE_QTY
				   END),0)
				   ELSE
				   Sum(CASE
					 WHEN A.LONG_SHORT = 'LONG' THEN ( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
					 ELSE -( CURRENT_OPEN_QUANTITY * UOM_FACTOR_FROM_POS_TO_RPT )
				   END)
			END
		   AS QTY,
       A.CONTRACT_BOOK,
	   COMMODITY,
       --A.CONTRACT_BOOK + ' ' + A.COMMODITY AS COMMODITY,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 'Purchase Contract - Differential Price'
       --  ELSE 'Sales Contract - Differential Price'
       --END                                 AS POSITION_TYPE,
       --0                                   AS FLAG,
       --CASE
       --  WHEN A.LONG_SHORT = 'LONG' THEN 24
       --  ELSE 26
       --END                                 AS ORDERBY,
       --'OIL Position'                      AS POSITION,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
       END                                 AS SHIP_MONTH,
	   CASE
         WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
         ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
              + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
              + '-'
              + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
       END                                 AS TERM_MONTH,
       CASE
         WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
         ELSE PHYSICAL_DELIVERY_MONTHNUMBER
       END                                 AS MONTHNUMBER,
	   PROFIT_CENTER
FROM   DAILY_PNL_ATTRIBUTION A
       LEFT JOIN DAILY_CONTRACT_DATA CTR
              ON A.POSITION_ID = CTR.POSITION_ID
		----360215 - Start
	   LEFT JOIN (
					SELECT POSITION_ID, ALLOCATION_ID, SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY, SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
					FROM
					(
						SELECT
							  X.POSITION_ID,
							  X.ALLOCATION_ID,
							  X.TOTAL_FIXED_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_FIXED_PRICE_QTY,
							  X.TOTAL_PROV_PRICE_QTY - ISNULL(Y.REALIZED_QUANTITY, 0) TOTAL_PROV_PRICE_QTY
							  --X.TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  T1.ALLOCATION_ID,
							  POSITION_ID,
							  SUM(TOTAL_FIXED_PRICE_QTY) AS TOTAL_FIXED_PRICE_QTY,
							  SUM(TOTAL_PROV_PRICE_QTY) AS TOTAL_PROV_PRICE_QTY
							FROM (SELECT
							  ALLOCATION_ID,
							  POSITION_ID,
							  LOAD_ID,
							  MAX(TOTAL_FIXED_PRICE_QTY) TOTAL_FIXED_PRICE_QTY,
							  MIN(TOTAL_PROV_PRICE_QTY) TOTAL_PROV_PRICE_QTY
							FROM DUMP_BI_FINANCIAL_LOAD_DETAILS D
							WHERE DOCUMENT_DATE <= $P{asofdate}-- AND ALLOCATION_ID <> PRICING_ID
							GROUP BY ALLOCATION_ID,
									 POSITION_ID,
									 pricing_id,
									 LOAD_ID) T1
							GROUP BY T1.ALLOCATION_ID,
									 POSITION_ID) X
							LEFT JOIN (SELECT
							  SUM(REALIZED_QUANTITY) REALIZED_QUANTITY,
							  POSITION_ID,
							  ALLOCATION_ID,
							  PRICING_ID
							FROM DAILY_PNL_REALIZATION DPR
							WHERE REALIZED_DATE <= $P{asofdate}
							GROUP BY POSITION_ID,
									 ALLOCATION_ID,
									 PRICING_ID) Y
							  ON X.POSITION_ID = Y.POSITION_ID
							  AND X.ALLOCATION_ID = y.ALLOCATION_ID
					) B1
					GROUP BY POSITION_ID, ALLOCATION_ID
					) B
				ON A.POSITION_ID = B.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID
		--360215 - End

WHERE  A.INSTRUMENT_TYPE = 'PHYSICAL'
AND EOD_DATE  = $P{asofdate}
       --AND A.ALLOCATION_TYPE <> 'STOCK'
	   AND A.ALLOCATION_TYPE IS NOT NULL
       AND PRICING_TYPE = 'UNPRICED'
       AND BASIS_MARKET_PRICE_INDEX IS NOT NULL
       AND BASIS_MARKET_PRICE_INDEX <> 'NA'
       AND A.ALLOCATION_ID = PRICING_ID
	   --360748
		AND NOT EXISTS(SELECT 1 FROM DUMP_BI_FINANCIAL_LOAD_DETAILS WHERE B.POSITION_ID = A.POSITION_ID AND A.ALLOCATION_ID = B.ALLOCATION_ID AND A.LONG_SHORT = 'LONG' and allocation_type = 'STOCK')
AND CONTRACT_BOOK like $P{cbk}
AND COMMODITY like $P{cmd}
AND PROFIT_CENTER like $P{pc}
AND PHYSICAL_DELIVERY_MONTH LIKE $P{shipmonth}
AND COALESCE(CTR.FUTURE_TERM,'') LIKE $P{futterm}
$P!{QSTR_Filter}
GROUP  BY A.COMMODITY,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
            ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 1)
                 + Lower(RIGHT(CONVERT(VARCHAR(3), PHYSICAL_DELIVERY_MONTH, 113), 2))
                 + '-'
                 + RIGHT(RIGHT(CONVERT(VARCHAR(11), PHYSICAL_DELIVERY_MONTH, 113), 8), 2)
          END,
		  CASE
			 WHEN ISNULL(FUTURE_DELIVERY_MONTHNUMBER,PHYSICAL_DELIVERY_MONTHNUMBER) < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 'Expired'
			 ELSE LEFT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 1)
				  + Lower(RIGHT(CONVERT(VARCHAR(3), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 2))
				  + '-'
				  + RIGHT(RIGHT(CONVERT(VARCHAR(11), ISNULL(FUTURE_DELIVERY_MONTH,PHYSICAL_DELIVERY_MONTH), 113), 8), 2)
		   END,
          CASE
            WHEN PHYSICAL_DELIVERY_MONTHNUMBER < Replace(LEFT(CONVERT(VARCHAR(10), (CAST($P{asofdate} AS DATE)), 111), 7), '/', '') THEN 1
            ELSE PHYSICAL_DELIVERY_MONTHNUMBER
          END,
          LONG_SHORT,
          A.CONTRACT_BOOK,
		  PROFIT_CENTER,
		  --
		  PHYSICAL_DELIVERY_MONTHNUMBER,
		  PHYSICAL_DELIVERY_MONTH,
		  FUTURE_DELIVERY_MONTHNUMBER,
		  FUTURE_DELIVERY_MONTH,B.TOTAL_PROV_PRICE_QTY,A.ALLOCATION_TYPE
		--Net Differentials 360215 - End
		) T
		GROUP BY CONTRACT_BOOK,COMMODITY,SHIP_MONTH,TERM_MONTH,MONTHNUMBER,PROFIT_CENTER
				  ) CTR
GROUP  BY CTR.COMMODITY,
          CTR.SHIP_MONTH,
		  CTR.TERM_MONTH,
          CTR.MONTHNUMBER,
          CTR.CONTRACT_BOOK,
		  CTR.PROFIT_CENTER
		  ) Superset_tbl
WHERE PROFIT_CENTER like $P{pc}
GROUP  BY Superset_tbl.COMMODITY,
          Superset_tbl.MONTHNUMBER,
          Superset_tbl.CONTRACT_BOOK,
		  Superset_tbl.QTY,
		  Superset_tbl.POSITION_TYPE,
		  Superset_tbl.FLAG
		 ,Superset_tbl.ORDERBY
		 ,Superset_tbl.POSITION
		 ,Superset_tbl.SHIP_MONTH
		 ,Superset_tbl.TERM_MONTH
		 ,Superset_tbl.PROFIT_CENTER
) T1
WHERE INS_TYPE like $P{instrument_type}
AND QTY <> 0
ORDER  BY 2,
          6,
          9]]>
		</queryString>
		<field name="QTY" class="java.math.BigDecimal"/>
		<field name="CONTRACT_BOOK" class="java.lang.String"/>
		<field name="COMMODITY" class="java.lang.String"/>
		<field name="POSITION_TYPE" class="java.lang.String"/>
		<field name="FLAG" class="java.lang.Integer"/>
		<field name="ORDERBY" class="java.lang.Integer"/>
		<field name="POSITION" class="java.lang.String"/>
		<field name="SHIP_MONTH" class="java.lang.String"/>
		<field name="MONTHNUMBER" class="java.lang.Integer"/>
		<field name="INS_TYPE" class="java.lang.String"/>
		<group name="Group1">
			<groupExpression><![CDATA[$F{CONTRACT_BOOK}]]></groupExpression>
		</group>
	</subDataset>
	<parameter name="cbk" class="java.lang.String"/>
	<parameter name="pc" class="java.lang.String"/>
	<parameter name="cmd" class="java.lang.String"/>
	<parameter name="shipmonth" class="java.lang.String"/>
	<parameter name="futterm" class="java.lang.String"/>
	<parameter name="LE_Filter" class="java.lang.String">
		<parameterDescription><![CDATA[]]></parameterDescription>
		<defaultValueExpression><![CDATA[' ']]></defaultValueExpression>
	</parameter>
	<parameter name="QSTR_Filter" class="java.lang.String" isForPrompting="false">
		<parameterDescription><![CDATA[]]></parameterDescription>
		<defaultValueExpression><![CDATA[" AND w.CONTRACT_BOOK IN ('" + $P{LE_Filter} + "')"]]></defaultValueExpression>
	</parameter>
	<parameter name="asofdate" class="java.util.Date"/>
	<parameter name="col_group" class="java.lang.String"/>
	<parameter name="origindate" class="java.util.Date">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="instrument_type" class="java.lang.String"/>
	<parameter name="QSTR_Filter_1" class="java.lang.String" isForPrompting="false">
		<parameterDescription><![CDATA[]]></parameterDescription>
		<defaultValueExpression><![CDATA[" AND CONTRACT_BOOK IN ('" + $P{LE_Filter} + "')"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT CTRBOOKCODE FROM DIM_CONTRACT_BOOK WHERE CTRBOOKCODE like $P{cbk}]]>
	</queryString>
	<field name="CTRBOOKCODE" class="java.lang.String"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<detail>
		<band>
			<property name="local_mesure_unitheight" value="pixel"/>
			<property name="com.jaspersoft.studio.unit.height" value="px"/>
			<crosstab columnBreakOffset="20" ignoreWidth="true">
				<reportElement isPrintRepeatedValues="false" x="0" y="0" width="1960" height="0" uuid="67e10ad7-fa2f-45a3-be70-39ae455d2c37">
					<property name="local_mesure_unitx" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.x" value="px"/>
					<property name="local_mesure_unitwidth" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
					<property name="local_mesure_unitheight" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<crosstabParameter name="drilldown_path">
					<parameterValueExpression><![CDATA["/standard/Drilldown_Report/"]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="cbk">
					<parameterValueExpression><![CDATA[$P{cbk}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="pc">
					<parameterValueExpression><![CDATA[$P{pc}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="cmd">
					<parameterValueExpression><![CDATA[$P{cmd}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="futterm">
					<parameterValueExpression><![CDATA[$P{futterm}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="shipmonth">
					<parameterValueExpression><![CDATA[$P{shipmonth}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="asofdate" class="java.util.Date">
					<parameterValueExpression><![CDATA[$P{asofdate}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabParameter name="col_group">
					<parameterValueExpression><![CDATA[$P{col_group}]]></parameterValueExpression>
				</crosstabParameter>
				<crosstabDataset>
					<dataset>
						<datasetRun subDataset="ctrbook" uuid="f5b3f465-34fa-4fa5-a1d1-2bd2841f78c3">
							<datasetParameter name="cbk">
								<datasetParameterExpression><![CDATA[$F{CTRBOOKCODE}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="pc">
								<datasetParameterExpression><![CDATA[$P{pc}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="cmd">
								<datasetParameterExpression><![CDATA[$P{cmd}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="shipmonth">
								<datasetParameterExpression><![CDATA[$P{shipmonth}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="futterm">
								<datasetParameterExpression><![CDATA[$P{futterm}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="LE_Filter">
								<datasetParameterExpression><![CDATA[$P{LE_Filter}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="QSTR_Filter">
								<datasetParameterExpression><![CDATA[$P{QSTR_Filter}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="asofdate">
								<datasetParameterExpression><![CDATA[$P{asofdate}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="origindate">
								<datasetParameterExpression><![CDATA[$P{origindate}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="col_group">
								<datasetParameterExpression><![CDATA[$P{col_group}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="instrument_type">
								<datasetParameterExpression><![CDATA[$P{instrument_type}]]></datasetParameterExpression>
							</datasetParameter>
							<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
						</datasetRun>
					</dataset>
				</crosstabDataset>
				<crosstabHeaderCell>
					<cellContents style="Crosstab 2_CH">
						<box>
							<topPen lineColor="#4F81BD"/>
							<leftPen lineColor="#4F81BD"/>
							<bottomPen lineColor="#4F81BD"/>
							<rightPen lineColor="#4F81BD"/>
						</box>
						<staticText>
							<reportElement stretchType="RelativeToBandHeight" mode="Opaque" x="0" y="0" width="100" height="20" forecolor="#000000" backcolor="#8DB4E2" uuid="a1e5b540-7670-4cf3-8e55-08fa127c3c05"/>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Center" verticalAlignment="Middle">
								<font fontName="Arial" size="11" isBold="true"/>
							</textElement>
							<text><![CDATA[Contract Book]]></text>
						</staticText>
						<textField>
							<reportElement stretchType="RelativeToBandHeight" mode="Opaque" x="100" y="0" width="170" height="20" backcolor="#8DB4E2" uuid="6af846bb-f79a-450d-a971-bd268e82e13e">
								<property name="local_mesure_unity" value="pixel"/>
								<property name="com.jaspersoft.studio.unit.y" value="px"/>
								<property name="local_mesure_unitwidth" value="pixel"/>
								<property name="com.jaspersoft.studio.unit.width" value="px"/>
								<property name="local_mesure_unitx" value="pixel"/>
								<property name="com.jaspersoft.studio.unit.x" value="px"/>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Center" verticalAlignment="Middle">
								<font fontName="Arial" size="11" isBold="true"/>
							</textElement>
							<textFieldExpression><![CDATA["Position"]]></textFieldExpression>
						</textField>
						<textField>
							<reportElement stretchType="RelativeToTallestObject" mode="Opaque" x="270" y="0" width="220" height="20" backcolor="#8DB4E2" uuid="f05c6bcb-6f66-4708-adcf-c3308d560b65">
								<property name="local_mesure_unity" value="pixel"/>
								<property name="com.jaspersoft.studio.unit.y" value="px"/>
								<property name="local_mesure_unitwidth" value="pixel"/>
								<property name="com.jaspersoft.studio.unit.width" value="px"/>
								<property name="local_mesure_unitx" value="pixel"/>
								<property name="com.jaspersoft.studio.unit.x" value="px"/>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Center" verticalAlignment="Middle">
								<font fontName="Arial" size="11" isBold="true"/>
							</textElement>
							<textFieldExpression><![CDATA["Position Type"]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabHeaderCell>
				<rowGroup name="CONTRACT_BOOK1" width="100">
					<bucket class="java.lang.String">
						<bucketExpression><![CDATA[$F{CONTRACT_BOOK}]]></bucketExpression>
					</bucket>
					<crosstabRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CD">
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
							<textField isStretchWithOverflow="true" isBlankWhenNull="true">
								<reportElement x="0" y="0" width="100" height="20" uuid="bb1deb2c-06d6-4b8d-a9c3-a7df5e1993d1">
									<property name="local_mesure_unitheight" value="pixel"/>
									<property name="com.jaspersoft.studio.unit.height" value="px"/>
								</reportElement>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Arial" size="10"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{CONTRACT_BOOK1}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabRowHeader>
					<crosstabTotalRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CT">
							<staticText>
								<reportElement x="0" y="0" width="300" height="20" uuid="afbd9ad3-6bbc-4816-9b49-d8121110345e"/>
								<text><![CDATA[Total CONTRACT_BOOK1]]></text>
							</staticText>
						</cellContents>
					</crosstabTotalRowHeader>
				</rowGroup>
				<rowGroup name="ORDERBY1" width="0">
					<bucket class="java.lang.Integer">
						<bucketExpression><![CDATA[$F{ORDERBY}]]></bucketExpression>
					</bucket>
					<crosstabRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CD">
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
						</cellContents>
					</crosstabRowHeader>
					<crosstabTotalRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CG">
							<staticText>
								<reportElement x="0" y="0" width="240" height="20" uuid="77c7f568-dd43-4bc3-88db-a5a983f8dbdd"/>
								<text><![CDATA[Total ORDERBY1]]></text>
							</staticText>
						</cellContents>
					</crosstabTotalRowHeader>
				</rowGroup>
				<rowGroup name="FLAG1" width="0">
					<bucket class="java.lang.Integer">
						<bucketExpression><![CDATA[$F{FLAG}]]></bucketExpression>
					</bucket>
					<crosstabRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CD">
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
						</cellContents>
					</crosstabRowHeader>
					<crosstabTotalRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CG">
							<staticText>
								<reportElement x="0" y="0" width="180" height="20" uuid="65e98392-0e46-43a5-a65e-b959802d34e0"/>
								<text><![CDATA[Total FLAG1]]></text>
							</staticText>
						</cellContents>
					</crosstabTotalRowHeader>
				</rowGroup>
				<rowGroup name="POSITION1" width="170">
					<bucket class="java.lang.String">
						<bucketExpression><![CDATA[$F{POSITION}]]></bucketExpression>
					</bucket>
					<crosstabRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CD">
							<property name="local_mesure_unitwidth" value="pixel"/>
							<property name="com.jaspersoft.studio.unit.width" value="px"/>
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
							<textField isStretchWithOverflow="true" isBlankWhenNull="true">
								<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="170" height="20" uuid="f9543c66-95a6-4500-9c96-f498017645d6">
									<property name="com.jaspersoft.studio.unit.height" value="px"/>
									<printWhenExpression><![CDATA[$V{FLAG1}!=1]]></printWhenExpression>
								</reportElement>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Arial" size="10"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{POSITION1}]]></textFieldExpression>
							</textField>
							<textField isStretchWithOverflow="true" isBlankWhenNull="true">
								<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="170" height="20" uuid="98378b23-c8d5-4014-83cb-b71df3c63bcc">
									<property name="com.jaspersoft.studio.unit.height" value="px"/>
									<property name="local_mesure_unity" value="pixel"/>
									<property name="com.jaspersoft.studio.unit.y" value="px"/>
									<property name="local_mesure_unitx" value="pixel"/>
									<property name="com.jaspersoft.studio.unit.x" value="px"/>
									<printWhenExpression><![CDATA[$V{FLAG1}==1]]></printWhenExpression>
								</reportElement>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Arial" size="10" isBold="true" isItalic="false"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{POSITION1}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabRowHeader>
					<crosstabTotalRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CG">
							<staticText>
								<reportElement x="0" y="0" width="120" height="20" uuid="71eeefe5-e4e0-4a8c-96f0-b50cc29a7a67"/>
								<text><![CDATA[Total POSITION1]]></text>
							</staticText>
						</cellContents>
					</crosstabTotalRowHeader>
				</rowGroup>
				<rowGroup name="POSITION_TYPE1" width="220">
					<bucket class="java.lang.String">
						<bucketExpression><![CDATA[$F{POSITION_TYPE}]]></bucketExpression>
					</bucket>
					<crosstabRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CD">
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
							<textField isStretchWithOverflow="true" isBlankWhenNull="true">
								<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="220" height="20" uuid="0269f1e0-2c99-4ebf-85b2-f0a225da7994">
									<printWhenExpression><![CDATA[$V{FLAG1}!=1]]></printWhenExpression>
								</reportElement>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Arial" size="10"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{POSITION_TYPE1}]]></textFieldExpression>
							</textField>
							<textField isStretchWithOverflow="true" isBlankWhenNull="true">
								<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="220" height="20" uuid="6b25a88a-dc09-428b-9e46-741319970b7a">
									<property name="com.jaspersoft.studio.unit.y" value="px"/>
									<property name="com.jaspersoft.studio.unit.x" value="px"/>
									<printWhenExpression><![CDATA[$V{FLAG1}==1]]></printWhenExpression>
								</reportElement>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement verticalAlignment="Middle">
									<font fontName="Arial" size="10" isBold="true" isItalic="false"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{POSITION_TYPE1}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabRowHeader>
					<crosstabTotalRowHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CG">
							<staticText>
								<reportElement x="0" y="0" width="60" height="20" uuid="ec80472b-e036-4178-9fc3-092f6114d593"/>
								<text><![CDATA[Total POSITION_TYPE1]]></text>
							</staticText>
						</cellContents>
					</crosstabTotalRowHeader>
				</rowGroup>
				<columnGroup name="MONTHNUMBER1" height="0" totalPosition="Start">
					<bucket class="java.lang.Integer">
						<bucketExpression><![CDATA[$F{MONTHNUMBER}]]></bucketExpression>
					</bucket>
					<crosstabColumnHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CH">
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
						</cellContents>
					</crosstabColumnHeader>
					<crosstabTotalColumnHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CH">
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
							<staticText>
								<reportElement stretchType="RelativeToBandHeight" mode="Opaque" x="0" y="0" width="100" height="20" backcolor="#8DB4E2" uuid="9e4434e2-c1da-4669-8cec-c9ca40b9c466"/>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Arial" size="11" isBold="true"/>
								</textElement>
								<text><![CDATA[Total MONTHNUMBER1]]></text>
							</staticText>
						</cellContents>
					</crosstabTotalColumnHeader>
				</columnGroup>
				<columnGroup name="SHIP_MONTH1" height="20">
					<bucket class="java.lang.String">
						<bucketExpression><![CDATA[$F{SHIP_MONTH}]]></bucketExpression>
					</bucket>
					<crosstabColumnHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CH">
							<property name="local_mesure_unitwidth" value="pixel"/>
							<property name="com.jaspersoft.studio.unit.width" value="px"/>
							<box>
								<topPen lineColor="#4F81BD"/>
								<leftPen lineColor="#4F81BD"/>
								<bottomPen lineColor="#4F81BD"/>
								<rightPen lineColor="#4F81BD"/>
							</box>
							<textField isStretchWithOverflow="true">
								<reportElement stretchType="RelativeToBandHeight" mode="Opaque" x="0" y="0" width="100" height="20" backcolor="#8DB4E2" uuid="42dba77f-d0c8-4fdd-90ef-e3ddb97a72ea"/>
								<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
									<topPen lineWidth="0.25" lineColor="#1F497D"/>
									<leftPen lineWidth="0.25" lineColor="#1F497D"/>
									<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
									<rightPen lineWidth="0.25" lineColor="#1F497D"/>
								</box>
								<textElement textAlignment="Center" verticalAlignment="Middle">
									<font fontName="Arial" size="11" isBold="true"/>
								</textElement>
								<textFieldExpression><![CDATA[$V{SHIP_MONTH1}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabColumnHeader>
					<crosstabTotalColumnHeader>
						<cellContents mode="Opaque" style="Crosstab 2_CH">
							<property name="local_mesure_unitwidth" value="pixel"/>
						</cellContents>
					</crosstabTotalColumnHeader>
				</columnGroup>
				<measure name="QTY_MEASURE1" class="java.math.BigDecimal" calculation="Sum">
					<measureExpression><![CDATA[$F{QTY}]]></measureExpression>
				</measure>
				<crosstabCell width="100" height="20">
					<cellContents mode="Opaque" style="Crosstab 2_CD">
						<box>
							<topPen lineColor="#4F81BD"/>
							<leftPen lineColor="#4F81BD"/>
							<bottomPen lineColor="#4F81BD"/>
							<rightPen lineColor="#4F81BD"/>
						</box>
						<textField isStretchWithOverflow="true" pattern="#,##0;(#,##0)" isBlankWhenNull="true" hyperlinkType="ReportExecution" hyperlinkTarget="Blank">
							<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="100" height="20" uuid="277975f1-2ff5-404b-a1a2-66f27225bb4a">
								<printWhenExpression><![CDATA[$V{FLAG1}!=1]]></printWhenExpression>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Right" verticalAlignment="Middle">
								<font fontName="Arial" size="10"/>
							</textElement>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
							<hyperlinkParameter name="_report">
								<hyperlinkParameterExpression><![CDATA[$P{drilldown_path}+ ($V{ORDERBY1}==41 ? "EOD_market_risk_details_derivatives" : $V{ORDERBY1}==42 ? "EOD_market_risk_details_derivatives" : "EOD_market_risk_details_physical")]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp">
								<hyperlinkParameterExpression><![CDATA[1]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{CONTRACT_BOOK1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp">
								<hyperlinkParameterExpression><![CDATA[$P{col_group}.equals( "pc" )? "1":$P{col_group}.equals( "sm" )? "2":"3"]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{SHIP_MONTH1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="position">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="postype">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION_TYPE1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cbk">
								<hyperlinkParameterExpression><![CDATA[$P{cbk}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cmd">
								<hyperlinkParameterExpression><![CDATA[$P{cmd}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="pc">
								<hyperlinkParameterExpression><![CDATA[$P{pc}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="futterm">
								<hyperlinkParameterExpression><![CDATA[$P{futterm}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="shipmonth">
								<hyperlinkParameterExpression><![CDATA[$P{shipmonth}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="asofdate">
								<hyperlinkParameterExpression><![CDATA[$P{asofdate}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
						</textField>
						<textField isStretchWithOverflow="true" pattern="#,##0;(#,##0)" isBlankWhenNull="true" hyperlinkType="ReportExecution" hyperlinkTarget="Blank">
							<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="100" height="20" uuid="7041302f-a163-4d42-a6ed-a8ad683eb651">
								<property name="com.jaspersoft.studio.unit.y" value="px"/>
								<property name="com.jaspersoft.studio.unit.x" value="px"/>
								<printWhenExpression><![CDATA[$V{ORDERBY1}==17||$V{ORDERBY1}==27||$V{ORDERBY1}==31||$V{ORDERBY1}==32||$V{ORDERBY1}==53]]></printWhenExpression>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Right" verticalAlignment="Middle">
								<font fontName="Arial" size="10" isBold="true" isItalic="false"/>
							</textElement>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
							<hyperlinkParameter name="_report">
								<hyperlinkParameterExpression><![CDATA[$P{drilldown_path}+ ($V{ORDERBY1}==41 ? "EOD_market_risk_details_derivatives" : $V{ORDERBY1}==42 ? "EOD_market_risk_details_derivatives" : "EOD_market_risk_details_physical")]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp">
								<hyperlinkParameterExpression><![CDATA[1]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{CONTRACT_BOOK1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp">
								<hyperlinkParameterExpression><![CDATA[$P{col_group}.equals( "pc" )? "1":$P{col_group}.equals( "sm" )? "2":"3"]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{SHIP_MONTH1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="position">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="postype">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION_TYPE1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cbk">
								<hyperlinkParameterExpression><![CDATA[$P{cbk}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cmd">
								<hyperlinkParameterExpression><![CDATA[$P{cmd}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="pc">
								<hyperlinkParameterExpression><![CDATA[$P{pc}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="futterm">
								<hyperlinkParameterExpression><![CDATA[$P{futterm}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="shipmonth">
								<hyperlinkParameterExpression><![CDATA[$P{shipmonth}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="asofdate">
								<hyperlinkParameterExpression><![CDATA[$P{asofdate}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
						</textField>
						<textField isStretchWithOverflow="true" pattern="#,##0;(#,##0)" isBlankWhenNull="true" hyperlinkTarget="Blank">
							<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="100" height="20" uuid="ac524cf6-455a-4a78-aacb-21982f7eb17b">
								<property name="com.jaspersoft.studio.unit.y" value="px"/>
								<property name="com.jaspersoft.studio.unit.x" value="px"/>
								<printWhenExpression><![CDATA[$V{ORDERBY1}==44||$V{ORDERBY1}==51||$V{ORDERBY1}==52||$V{ORDERBY1}==54]]></printWhenExpression>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Right" verticalAlignment="Middle">
								<font fontName="Arial" size="10" isBold="true" isItalic="false"/>
							</textElement>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
							<hyperlinkParameter name="_report">
								<hyperlinkParameterExpression><![CDATA[$P{drilldown_path}+ ($V{ORDERBY1}==41 ? "market_risk_details_derivatives" : $V{ORDERBY1}==42 ? "market_risk_details_derivatives" : "market_risk_details_physical")]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp">
								<hyperlinkParameterExpression><![CDATA[1]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{CONTRACT_BOOK1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp">
								<hyperlinkParameterExpression><![CDATA[2]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{SHIP_MONTH1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="position">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="postype">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION_TYPE1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="100" height="20" columnTotalGroup="MONTHNUMBER1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<property name="local_mesure_unitwidth" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.width" value="px"/>
						<box>
							<topPen lineColor="#4F81BD"/>
							<leftPen lineColor="#4F81BD"/>
							<bottomPen lineColor="#4F81BD"/>
							<rightPen lineColor="#4F81BD"/>
						</box>
						<textField pattern="#,##0;(#,##0)" hyperlinkType="ReportExecution" hyperlinkTarget="Blank">
							<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="100" height="20" uuid="62c00e63-20a2-4d87-93d6-b0a114a3b1b1">
								<printWhenExpression><![CDATA[$V{FLAG1}!=1]]></printWhenExpression>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Right" verticalAlignment="Middle">
								<font fontName="Arial" size="10"/>
							</textElement>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
							<hyperlinkParameter name="_report">
								<hyperlinkParameterExpression><![CDATA[$P{drilldown_path}+ ($V{ORDERBY1}==41 ? "EOD_market_risk_details_derivatives" : $V{ORDERBY1}==42 ? "EOD_market_risk_details_derivatives" : "EOD_market_risk_details_physical")]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp">
								<hyperlinkParameterExpression><![CDATA[1]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{CONTRACT_BOOK1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp">
								<hyperlinkParameterExpression><![CDATA[$P{col_group}.equals( "pc" )? "1":$P{col_group}.equals( "sm" )? "2":"3"]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{SHIP_MONTH1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="position">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="postype">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION_TYPE1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cbk">
								<hyperlinkParameterExpression><![CDATA[$P{cbk}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cmd">
								<hyperlinkParameterExpression><![CDATA[$P{cmd}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="pc">
								<hyperlinkParameterExpression><![CDATA[$P{pc}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="futterm">
								<hyperlinkParameterExpression><![CDATA[$P{futterm}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="shipmonth">
								<hyperlinkParameterExpression><![CDATA[$P{shipmonth}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="asofdate">
								<hyperlinkParameterExpression><![CDATA[$P{asofdate}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
						</textField>
						<textField pattern="#,##0;(#,##0)" hyperlinkType="ReportExecution" hyperlinkTarget="Blank">
							<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="100" height="20" uuid="3938385c-a5ba-4368-9afb-c588db98fe8f">
								<property name="com.jaspersoft.studio.unit.y" value="px"/>
								<property name="com.jaspersoft.studio.unit.x" value="px"/>
								<printWhenExpression><![CDATA[$V{ORDERBY1}==17||$V{ORDERBY1}==27||$V{ORDERBY1}==31||$V{ORDERBY1}==32||$V{ORDERBY1}==53]]></printWhenExpression>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Right" verticalAlignment="Middle">
								<font fontName="Arial" size="10" isBold="true" isItalic="false"/>
							</textElement>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
							<hyperlinkParameter name="_report">
								<hyperlinkParameterExpression><![CDATA[$P{drilldown_path}+ ($V{ORDERBY1}==41 ? "EOD_market_risk_details_derivatives" : $V{ORDERBY1}==42 ? "EOD_market_risk_details_derivatives" : "EOD_market_risk_details_physical")]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp">
								<hyperlinkParameterExpression><![CDATA[1]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{CONTRACT_BOOK1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp">
								<hyperlinkParameterExpression><![CDATA[$P{col_group}.equals( "pc" )? "1":$P{col_group}.equals( "sm" )? "2":"3"]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{SHIP_MONTH1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="position">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="postype">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION_TYPE1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cbk">
								<hyperlinkParameterExpression><![CDATA[$P{cbk}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="cmd">
								<hyperlinkParameterExpression><![CDATA[$P{cmd}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="pc">
								<hyperlinkParameterExpression><![CDATA[$P{pc}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="futterm">
								<hyperlinkParameterExpression><![CDATA[$P{futterm}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="shipmonth">
								<hyperlinkParameterExpression><![CDATA[$P{shipmonth}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="asofdate">
								<hyperlinkParameterExpression><![CDATA[$P{asofdate}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
						</textField>
						<textField pattern="#,##0;(#,##0)" hyperlinkTarget="Blank">
							<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="100" height="20" uuid="21e390c2-7c51-47c3-a4f2-d667b892506d">
								<property name="com.jaspersoft.studio.unit.y" value="px"/>
								<property name="com.jaspersoft.studio.unit.x" value="px"/>
								<property name="local_mesure_unity" value="pixel"/>
								<property name="local_mesure_unitx" value="pixel"/>
								<printWhenExpression><![CDATA[$V{ORDERBY1}==44||$V{ORDERBY1}==51||$V{ORDERBY1}==52||$V{ORDERBY1}==54]]></printWhenExpression>
							</reportElement>
							<box topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
								<topPen lineWidth="0.25" lineColor="#1F497D"/>
								<leftPen lineWidth="0.25" lineColor="#1F497D"/>
								<bottomPen lineWidth="0.25" lineColor="#1F497D"/>
								<rightPen lineWidth="0.25" lineColor="#1F497D"/>
							</box>
							<textElement textAlignment="Right" verticalAlignment="Middle">
								<font fontName="Arial" size="10" isBold="true" isItalic="false"/>
							</textElement>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
							<hyperlinkParameter name="_report">
								<hyperlinkParameterExpression><![CDATA[$P{drilldown_path}+ ($V{ORDERBY1}==41 ? "market_risk_details_derivatives" : $V{ORDERBY1}==42 ? "market_risk_details_derivatives" : "market_risk_details_physical")]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp">
								<hyperlinkParameterExpression><![CDATA[1]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="row_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{CONTRACT_BOOK1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp">
								<hyperlinkParameterExpression><![CDATA[2]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="col_grp_value">
								<hyperlinkParameterExpression><![CDATA[$V{SHIP_MONTH1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="position">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
							<hyperlinkParameter name="postype">
								<hyperlinkParameterExpression><![CDATA[$V{POSITION_TYPE1}]]></hyperlinkParameterExpression>
							</hyperlinkParameter>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="80" height="20" columnTotalGroup="SHIP_MONTH1">
					<cellContents mode="Opaque" style="Crosstab 2_CD">
						<property name="local_mesure_unitwidth" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.width" value="px"/>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="CONTRACT_BOOK1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="d8cfe888-c084-42ee-bb6a-24301bb14237"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="CONTRACT_BOOK1" columnTotalGroup="MONTHNUMBER1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="421400d8-e7fc-41e7-a0eb-dbfe062eaf09"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="CONTRACT_BOOK1" columnTotalGroup="SHIP_MONTH1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="fdd05026-cd64-4b1f-951e-cf17cbabb3a2"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="ORDERBY1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="6c68bb9c-2a85-4b62-8695-5f1e948a3438"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="ORDERBY1" columnTotalGroup="MONTHNUMBER1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="fd7b6654-a35f-481b-84dd-17fdcc68a704"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="ORDERBY1" columnTotalGroup="SHIP_MONTH1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="46a0425d-48a8-41dd-9738-4bfca3055e64"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="FLAG1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="9be499c5-fef8-40ed-9124-76f41dda9262"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="FLAG1" columnTotalGroup="MONTHNUMBER1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="fd94dbba-d107-4297-8e64-ad6e485eec68"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="FLAG1" columnTotalGroup="SHIP_MONTH1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="95a6c4ad-d572-4d21-ad97-e18f9738fcfa"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="POSITION1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="c6e2db13-a138-44eb-9fa8-76cbf7530bd7"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="POSITION1" columnTotalGroup="MONTHNUMBER1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="28b9393e-47bf-4cf9-ab5a-3dca4d78bd71"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="POSITION1" columnTotalGroup="SHIP_MONTH1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="18f431c8-5eb5-45c8-b767-fed3abd07450"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="POSITION_TYPE1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="4975e6d0-70a9-4bd1-8225-111427d067c7"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="POSITION_TYPE1" columnTotalGroup="MONTHNUMBER1">
					<cellContents mode="Opaque" style="Crosstab 2_CT">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="98723d6b-ac47-49b8-ac35-b5f8cb9baadd"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
				<crosstabCell width="60" height="20" rowTotalGroup="POSITION_TYPE1" columnTotalGroup="SHIP_MONTH1">
					<cellContents mode="Opaque" style="Crosstab 2_CG">
						<textField>
							<reportElement x="0" y="0" width="60" height="20" uuid="e142894d-0dc2-4ac8-abe5-5b31a3e5876e"/>
							<textFieldExpression><![CDATA[$V{QTY_MEASURE1}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>
			</crosstab>
		</band>
	</detail>
</jasperReport>
